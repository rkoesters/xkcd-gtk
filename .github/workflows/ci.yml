---

name: CI

'on':
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
      - 'v[0-9]+.[0-9]+.[0-9]+'
  schedule:
    - cron: '29 4 1 * *'

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        go:
          - 1.23.x
          - 1.24.x
          - 1.x     # latest

    name: go${{ matrix.go }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y -q appstream gettext libgtk-3-dev \
            libxml2-utils shellcheck yamllint
          go install \
            honnef.co/go/tools/cmd/staticcheck@latest

      - run: go mod graph
      - run: make
      - run: make check
      - run: make test

  flatpak-config:
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: false  # No go code will be compiled, do not cache nothing.

      - run: go mod graph
      - run: make -B flatpak/modules.txt
      - run: make -B flatpak/appcenter.yml
      - run: make -B flatpak/flathub.yml

      - name: Upload flatpak-config artifact
        uses: actions/upload-artifact@v6
        with:
          name: flatpak-config
          if-no-files-found: error
          path: |
            flatpak/modules.txt
            flatpak/*.yml

  flatpak-builder:
    strategy:
      matrix:
        arch:
          - aarch64
          - x86_64
        repo:
          - appcenter
          - flathub
        include:
          - arch: aarch64
            runs-on: ubuntu-24.04-arm
          - arch: x86_64
            runs-on: ubuntu-24.04
          - repo: appcenter
            repo-url: https://flatpak.elementary.io/repo.flatpakrepo
          - repo: appcenter
            arch: aarch64
            image: >-
              ghcr.io/elementary/flatpak-platform/runtime:8.2-aarch64
          - repo: appcenter
            arch: x86_64
            image: >-
              ghcr.io/elementary/flatpak-platform/runtime:8.2-x86_64
          - repo: flathub
            repo-url: https://flathub.org/repo/flathub.flatpakrepo
            image: >-
              ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-25.08

    name: ${{ matrix.repo }}-${{ matrix.arch }}
    needs: flatpak-config

    runs-on: ${{ matrix.runs-on }}
    container:
      image: ${{ matrix.image }}
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download flatpak-config artifact
        uses: actions/download-artifact@v7
        with:
          name: flatpak-config
          path: flatpak

      - name: Configure build
        run: tools/app-version.sh | tee tools/app-version.txt

      - uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: flatpak/${{ matrix.repo }}.yml
          repository-name: ${{ matrix.repo }}
          repository-url: ${{ matrix.repo-url }}
          arch: ${{ matrix.arch }}
          bundle: xkcd-gtk-${{ matrix.repo }}.flatpak
          verbose: true
